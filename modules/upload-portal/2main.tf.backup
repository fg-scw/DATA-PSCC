#===============================================================================
# UPLOAD PORTAL MODULE - VM-based (FIXED - htpasswd encoding)
# Deploys a VM with Docker to host the upload portal
#===============================================================================

locals {
  portal_name = "${var.project_prefix}-upload-portal"
}

#-------------------------------------------------------------------------------
# SSH Key for Upload Portal
#-------------------------------------------------------------------------------
resource "tls_private_key" "portal" {
  algorithm = "ED25519"
}

resource "scaleway_iam_ssh_key" "portal" {
  name       = "upload-portal-ssh-key"
  public_key = tls_private_key.portal.public_key_openssh
  project_id = var.admin_project_id
}

#-------------------------------------------------------------------------------
# Security Group
#-------------------------------------------------------------------------------
resource "scaleway_instance_security_group" "portal" {
  project_id              = var.admin_project_id
  zone                    = var.zone
  name                    = "${local.portal_name}-sg"
  inbound_default_policy  = "drop"
  outbound_default_policy = "accept"
  stateful                = true

  inbound_rule {
    action   = "accept"
    port     = 22
    protocol = "TCP"
  }

  inbound_rule {
    action   = "accept"
    port     = 80
    protocol = "TCP"
  }

  inbound_rule {
    action   = "accept"
    port     = 443
    protocol = "TCP"
  }
}

#-------------------------------------------------------------------------------
# Public IP
#-------------------------------------------------------------------------------
resource "scaleway_instance_ip" "portal" {
  project_id = var.admin_project_id
  zone       = var.zone
  tags       = ["hackathon", "upload-portal"]
}

#-------------------------------------------------------------------------------
# Generate provider passwords
#-------------------------------------------------------------------------------
resource "random_password" "provider_passwords" {
  for_each         = var.data_providers
  length           = 16
  special          = false
}

resource "random_password" "evaluator_password" {
  length           = 16
  special          = false
}

locals {
  provider_credentials = {
    for key, provider in var.data_providers : key => {
      username = lower(replace(replace(provider.name, " ", "-"), "&", "and"))
      password = random_password.provider_passwords[key].result
    }
  }
  
  evaluator_credentials = {
    username = "evaluator"
    password = random_password.evaluator_password.result
  }
  
  # Combine provider and evaluator credentials for htpasswd
  htpasswd_entries = concat(
    [for key, creds in local.provider_credentials : 
      "${creds.username}:${bcrypt(creds.password)}"],
    ["${local.evaluator_credentials.username}:${bcrypt(local.evaluator_credentials.password)}"]
  )
  
  htpasswd_content = join("\n", local.htpasswd_entries)
  
  # Base64 encode the htpasswd to avoid YAML parsing issues with $ characters
  htpasswd_base64 = base64encode(local.htpasswd_content)
}

#-------------------------------------------------------------------------------
# Instance
#-------------------------------------------------------------------------------
resource "scaleway_instance_server" "portal" {
  project_id = var.admin_project_id
  zone       = var.zone
  name       = local.portal_name
  type       = var.instance_type
  image      = "ubuntu_jammy"

  ip_id             = scaleway_instance_ip.portal.id
  security_group_id = scaleway_instance_security_group.portal.id

  root_volume {
    size_in_gb  = 40
    volume_type = "sbs_volume"
    sbs_iops    = 5000
  }

  user_data = {
    cloud-init = <<-CLOUDINIT
#cloud-config
package_update: true
packages:
  - docker.io
  - docker-compose
  - apache2-utils
  - python3-pip
  - python3-venv

write_files:
  - path: /opt/upload-portal/.env
    permissions: '0600'
    content: |
      SCW_ACCESS_KEY=${var.scw_access_key}
      SCW_SECRET_KEY=${var.scw_secret_key}
      SCW_REGION=${var.region}
      ZONE1_BUCKET=${var.zone1_bucket_name}
      ZONE2_BUCKET=${var.zone2_bucket_name}
      LIVRABLES_BUCKET=${var.livrables_bucket_name}
      ZONE1_KEY=${var.zone1_encryption_key}
      ZONE2_KEY=${var.zone2_encryption_key}
      LIVRABLES_KEY=${var.livrables_encryption_key}

  - path: /opt/upload-portal/htpasswd
    permissions: '0644'
    encoding: b64
    content: ${local.htpasswd_base64}

    - path: /opt/upload-portal/user_roles
      permissions: '0644'
      content: ${local.user_roles_content}

  - path: /opt/upload-portal/app.py
    permissions: '0644'
    content: |
      #!/usr/bin/env python3
      import os, base64, hashlib, boto3, traceback
      from datetime import datetime
      from flask import Flask, request, jsonify, render_template_string, Response
      from functools import wraps
      from botocore.exceptions import ClientError
      
      app = Flask(__name__)
      
      S3_ENDPOINT = f"https://s3.{os.environ.get('SCW_REGION', 'fr-par')}.scw.cloud"
      
      # Roles: which users can access which features
      USER_ROLES = {}  # username -> role (provider, evaluator, admin)
      USERS = {}
      
      try:
          with open('/opt/upload-portal/htpasswd') as f:
              for line in f:
                  if ':' in line:
                      u, p = line.strip().split(':', 1)
                      USERS[u] = p
          with open('/opt/upload-portal/user_roles') as f:
              for line in f:
                  if ':' in line:
                      u, r = line.strip().split(':', 1)
                      USER_ROLES[u] = r
      except Exception as e:
          print(f"Error loading config: {e}")
      
      def check_auth(u, p):
          import bcrypt
          if u in USERS:
              try:
                  return bcrypt.checkpw(p.encode(), USERS[u].encode())
              except Exception as e:
                  print(f"Auth error: {e}")
                  return False
          return False
      
      def get_user_role(username):
          return USER_ROLES.get(username, 'provider')
      
      def auth_required(f):
          @wraps(f)
          def decorated(*args, **kwargs):
              auth = request.authorization
              if not auth or not check_auth(auth.username, auth.password):
                  return ('Auth required', 401, {'WWW-Authenticate': 'Basic realm="Upload"'})
              return f(*args, **kwargs)
          return decorated
      
      def role_required(*roles):
          def decorator(f):
              @wraps(f)
              def decorated(*args, **kwargs):
                  auth = request.authorization
                  if not auth or get_user_role(auth.username) not in roles:
                      return jsonify({'success': False, 'error': 'Access denied'}), 403
                  return f(*args, **kwargs)
              return decorated
          return decorator
      
      def get_s3():
          return boto3.client('s3',
              endpoint_url=S3_ENDPOINT,
              aws_access_key_id=os.environ['SCW_ACCESS_KEY'],
              aws_secret_access_key=os.environ['SCW_SECRET_KEY'])
      
      def sse_params(zone):
          """Get SSE-C parameters for a zone"""
          key_b64 = os.environ.get(f'{zone.upper()}_KEY', '')
          if not key_b64:
              return None
          key_raw = base64.b64decode(key_b64)
          key_md5 = base64.b64encode(hashlib.md5(key_raw).digest()).decode()
          return {
              'SSECustomerAlgorithm': 'AES256',
              'SSECustomerKey': key_b64,
              'SSECustomerKeyMD5': key_md5
          }
      
      def sse_params_raw(zone):
          """Get SSE-C parameters with raw key for GetObject"""
          key_b64 = os.environ.get(f'{zone.upper()}_KEY', '')
          if not key_b64:
              return None
          key_raw = base64.b64decode(key_b64)
          key_md5 = base64.b64encode(hashlib.md5(key_raw).digest()).decode()
          return {
              'SSECustomerAlgorithm': 'AES256',
              'SSECustomerKey': key_raw,
              'SSECustomerKeyMD5': key_md5
          }
      
      def format_size(size):
          """Format file size in human readable format"""
          for unit in ['B', 'KB', 'MB', 'GB']:
              if size < 1024:
                  return f"{size:.1f} {unit}"
              size /= 1024
          return f"{size:.1f} TB"
      
      HTML = """<!DOCTYPE html><html><head><title>Upload HDS</title>
      <style>
      body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;max-width:1200px;margin:30px auto;padding:20px;background:#f0f2f5}
      .container{background:white;padding:30px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px}
      h1{color:#1a1a2e;margin-bottom:5px}
      h2{color:#16213e;margin-top:0;font-size:1.2em;border-bottom:2px solid #e0e0e0;padding-bottom:10px}
      .user-info{color:#666;margin-bottom:20px;font-size:0.95em}
      .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:0.8em;margin-left:10px}
      .badge-admin{background:#dc3545;color:white}
      .badge-evaluator{background:#28a745;color:white}
      .badge-provider{background:#007bff;color:white}
      .tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
      .tab{padding:12px 24px;background:#e8e8e8;border:none;border-radius:8px;cursor:pointer;font-size:15px;transition:all 0.2s}
      .tab:hover{background:#d0d0d0}
      .tab.active{background:#007bff;color:white}
      .tab.hidden{display:none}
      .zone{display:inline-block;padding:12px 20px;margin:5px;border:2px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.2s}
      .zone:hover{border-color:#007bff;background:#f8f9fa}
      .zone.active{border-color:#007bff;background:#e7f1ff}
      .drop{border:3px dashed #ccc;padding:50px;text-align:center;margin:20px 0;border-radius:8px;transition:all 0.2s;background:#fafafa}
      .drop:hover{border-color:#007bff;background:#f0f7ff}
      .drop.over{background:#e7f1ff;border-color:#007bff}
      .btn{padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;margin:5px}
      .btn:hover{background:#0056b3}
      .btn-sm{padding:6px 12px;font-size:12px}
      .btn-success{background:#28a745}
      .btn-success:hover{background:#1e7e34}
      .btn-danger{background:#dc3545}
      .btn-danger:hover{background:#c82333}
      #status{margin-top:15px;padding:15px;background:#f8f9fa;border-radius:6px;max-height:200px;overflow-y:auto;font-size:13px}
      .success{color:#28a745}
      .error{color:#dc3545}
      .info{color:#17a2b8}
      .file-list{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
      .file-list th,.file-list td{padding:10px 12px;text-align:left;border-bottom:1px solid #eee}
      .file-list th{background:#f8f9fa;font-weight:600;color:#333}
      .file-list tr:hover{background:#f8f9fa}
      .file-icon{margin-right:8px}
      .empty-state{text-align:center;padding:40px;color:#888}
      .refresh-btn{float:right;margin-top:-5px}
      .loading{text-align:center;padding:30px;color:#666}
      .panel{display:none}
      .panel.active{display:block}
      .team-filter{margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:6px}
      .team-filter select{padding:8px;border-radius:4px;border:1px solid #ddd;min-width:200px}
      .download-link{color:#007bff;text-decoration:none;cursor:pointer}
      .download-link:hover{text-decoration:underline}
      </style></head><body>
      <div class="container">
        <h1>Hackathon HDS - Upload Portal</h1>
        <p class="user-info">Connected as: <strong id="username"></strong><span id="role-badge" class="badge"></span></p>
        <div class="tabs">
          <button class="tab active" onclick="showPanel('upload')">Upload Files</button>
          <button class="tab" onclick="showPanel('browse')">Browse Uploads</button>
          <button class="tab" id="tab-livrables" onclick="showPanel('livrables')">Livrables</button>
        </div>
        
        <!-- Upload Panel -->
        <div id="upload-panel" class="panel active">
          <h2>Select Zone</h2>
          <div id="zones">
            <label class="zone active" onclick="selectZone(this,'zone1')"><input type="radio" name="zone" value="zone1" checked hidden> Zone 1 (Patients)</label>
            <label class="zone" onclick="selectZone(this,'zone2')"><input type="radio" name="zone" value="zone2" hidden> Zone 2 (Contexte)</label>
          </div>
          <div id="drop" class="drop" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            Drop files here or <input type="file" id="file" multiple onchange="handleFiles(this.files)" style="display:none">
            <button class="btn" onclick="document.getElementById('file').click()">Browse</button>
          </div>
          <div id="status"></div>
        </div>
        
        <!-- Browse Panel -->
        <div id="browse-panel" class="panel">
          <h2>Browse Files <button class="btn btn-sm refresh-btn" onclick="loadFiles()">Refresh</button></h2>
          <div id="zones-browse">
            <label class="zone active" onclick="selectBrowseZone(this,'zone1')"> Zone 1 (Patients)</label>
            <label class="zone" onclick="selectBrowseZone(this,'zone2')"> Zone 2 (Contexte)</label>
          </div>
          <div id="file-list-container"><div class="loading">Select a zone to browse files</div></div>
        </div>
        
        <!-- Livrables Panel (evaluators/admins only) -->
        <div id="livrables-panel" class="panel">
          <h2>Team Deliverables <button class="btn btn-sm refresh-btn" onclick="loadLivrables()">Refresh</button></h2>
          <div class="team-filter">
            <label>Filter by team: </label>
            <select id="team-filter" onchange="loadLivrables()">
              <option value="">All teams</option>
            </select>
          </div>
          <div id="livrables-list-container"><div class="loading">Loading deliverables...</div></div>
        </div>
      </div>
      
      <script>
      let zone='zone1', browseZone='zone1', userRole='provider';
      
      // Get user info on load
      fetch('/api/me').then(r=>r.json()).then(d=>{
        document.getElementById('username').textContent = d.username;
        userRole = d.role;
        const badge = document.getElementById('role-badge');
        badge.textContent = d.role;
        badge.className = 'badge badge-' + d.role;
        
        // Show/hide livrables tab based on role
        if (d.role === 'provider') {
          document.getElementById('tab-livrables').classList.add('hidden');
        }
      });
      
      function showPanel(p) {
        document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(p+'-panel').classList.add('active');
        event.target.classList.add('active');
        if(p==='browse') loadFiles();
        if(p==='livrables') loadLivrables();
      }
      
      function selectZone(el,z) { zone=z; document.querySelectorAll('#zones .zone').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
      function selectBrowseZone(el,z) { browseZone=z; document.querySelectorAll('#zones-browse .zone').forEach(e=>e.classList.remove('active')); el.classList.add('active'); loadFiles(); }
      function handleDragOver(e) { e.preventDefault(); e.target.classList.add('over'); }
      function handleDragLeave(e) { e.target.classList.remove('over'); }
      function handleDrop(e) { e.preventDefault(); e.target.classList.remove('over'); handleFiles(e.dataTransfer.files); }
      function handleFiles(files) { Array.from(files).forEach(f => uploadFile(f)); }
      function log(msg, type='info') { const s=document.getElementById('status'); s.innerHTML += '<div class="'+type+'">'+msg+'</div>'; s.scrollTop=s.scrollHeight; }
      
      async function uploadFile(file) {
        log('Uploading: '+file.name+'...');
        const fd=new FormData(); fd.append('file',file);
        try {
          const r=await fetch('/upload/'+zone, {method:'POST', body:fd});
          const d=await r.json();
          if(d.success) log('OK: '+d.message, 'success');
          else log('Error: '+d.error, 'error');
        } catch(e) { log('Failed: '+e.message, 'error'); }
      }
      
      async function loadFiles() {
        const container = document.getElementById('file-list-container');
        container.innerHTML = '<div class="loading">Loading...</div>';
        try {
          const r = await fetch('/files/' + browseZone);
          const d = await r.json();
          if (d.success && d.files.length > 0) {
            let html = '<table class="file-list"><thead><tr><th>Name</th><th>Size</th><th>Modified</th></tr></thead><tbody>';
            d.files.forEach(f => { html += '<tr><td><span class="file-icon">ðŸ“„</span>' + f.key + '</td><td>' + f.size + '</td><td>' + f.modified + '</td></tr>'; });
            html += '</tbody></table>';
            container.innerHTML = html;
          } else if (d.success) { container.innerHTML = '<div class="empty-state">No files in this zone</div>'; }
          else { container.innerHTML = '<div class="error">Error: ' + d.error + '</div>'; }
        } catch (e) { container.innerHTML = '<div class="error">Failed to load files: ' + e.message + '</div>'; }
      }
      
      async function loadLivrables() {
        const container = document.getElementById('livrables-list-container');
        const teamFilter = document.getElementById('team-filter').value;
        container.innerHTML = '<div class="loading">Loading deliverables...</div>';
        try {
          const r = await fetch('/api/livrables' + (teamFilter ? '?team=' + encodeURIComponent(teamFilter) : ''));
          const d = await r.json();
          
          // Update team filter options
          if (d.teams && d.teams.length > 0) {
            const select = document.getElementById('team-filter');
            const currentValue = select.value;
            select.innerHTML = '<option value="">All teams</option>';
            d.teams.forEach(t => {
              select.innerHTML += '<option value="'+t+'"'+(t===currentValue?' selected':'')+'>'+t+'</option>';
            });
          }
          
          if (d.success && d.files.length > 0) {
            let html = '<table class="file-list"><thead><tr><th>Team</th><th>Timestamp</th><th>File</th><th>Size</th><th>Action</th></tr></thead><tbody>';
            d.files.forEach(f => {
              html += '<tr>';
              html += '<td><strong>' + f.team + '</strong></td>';
              html += '<td>' + f.timestamp + '</td>';
              html += '<td><span class="file-icon">ðŸ“¦</span>' + f.filename + '</td>';
              html += '<td>' + f.size + '</td>';
              html += '<td><a class="download-link" href="/api/livrables/download?key=' + encodeURIComponent(f.key) + '">Download</a></td>';
              html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
          } else if (d.success) {
            container.innerHTML = '<div class="empty-state">No deliverables submitted yet</div>';
          } else {
            container.innerHTML = '<div class="error">Error: ' + d.error + '</div>';
          }
        } catch (e) {
          container.innerHTML = '<div class="error">Failed to load deliverables: ' + e.message + '</div>';
        }
      }
      </script></body></html>"""
      
      @app.route('/')
      @auth_required
      def index():
          return HTML
      
      @app.route('/api/me')
      @auth_required
      def api_me():
          auth = request.authorization
          return jsonify({
              'username': auth.username,
              'role': get_user_role(auth.username)
          })
      
      @app.route('/files/<zone>')
      @auth_required
      def list_files(zone):
          bucket = os.environ.get(f'{zone.upper()}_BUCKET')
          if not bucket:
              return jsonify({'success': False, 'error': f'Invalid zone: {zone}'}), 400
          
          try:
              s3 = get_s3()
              response = s3.list_objects_v2(Bucket=bucket, MaxKeys=500)
              
              files = []
              for obj in response.get('Contents', []):
                  files.append({
                      'key': obj['Key'],
                      'size': format_size(obj['Size']),
                      'modified': obj['LastModified'].strftime('%Y-%m-%d %H:%M')
                  })
              
              return jsonify({
                  'success': True,
                  'files': files,
                  'bucket': bucket
              })
          except ClientError as e:
              error_code = e.response.get('Error', {}).get('Code', 'Unknown')
              return jsonify({'success': False, 'error': f'S3 Error: {error_code}'}), 500
      
      @app.route('/api/livrables')
      @auth_required
      @role_required('evaluator', 'admin')
      def list_livrables():
          bucket = os.environ.get('LIVRABLES_BUCKET')
          if not bucket:
              return jsonify({'success': False, 'error': 'Livrables bucket not configured'}), 500
          
          team_filter = request.args.get('team', '')
          
          try:
              s3 = get_s3()
              response = s3.list_objects_v2(Bucket=bucket, MaxKeys=1000)
              
              files = []
              teams = set()
              
              for obj in response.get('Contents', []):
                  key = obj['Key']
                  parts = key.split('/')
                  
                  # Expected format: uploads/team/timestamp/filename or timestamp/filename
                  if len(parts) >= 2:
                      if parts[0] == 'uploads' and len(parts) >= 4:
                          team = parts[1]
                          timestamp = parts[2]
                          filename = '/'.join(parts[3:])
                      elif len(parts) >= 2:
                          # Format: timestamp/filename (from upload-livrable.sh)
                          team = 'direct-upload'
                          timestamp = parts[0]
                          filename = '/'.join(parts[1:])
                      else:
                          continue
                      
                      teams.add(team)
                      
                      if team_filter and team != team_filter:
                          continue
                      
                      files.append({
                          'key': key,
                          'team': team,
                          'timestamp': timestamp,
                          'filename': filename,
                          'size': format_size(obj['Size']),
                          'modified': obj['LastModified'].strftime('%Y-%m-%d %H:%M')
                      })
              
              # Sort by timestamp descending
              files.sort(key=lambda x: x['timestamp'], reverse=True)
              
              return jsonify({
                  'success': True,
                  'files': files,
                  'teams': sorted(list(teams)),
                  'bucket': bucket
              })
          except ClientError as e:
              error_code = e.response.get('Error', {}).get('Code', 'Unknown')
              return jsonify({'success': False, 'error': f'S3 Error: {error_code}'}), 500
      
      @app.route('/api/livrables/download')
      @auth_required
      @role_required('evaluator', 'admin')
      def download_livrable():
          bucket = os.environ.get('LIVRABLES_BUCKET')
          key = request.args.get('key')
          
          if not bucket or not key:
              return jsonify({'success': False, 'error': 'Missing parameters'}), 400
          
          try:
              s3 = get_s3()
              sse = sse_params_raw('livrables')
              
              if sse:
                  response = s3.get_object(Bucket=bucket, Key=key, **sse)
              else:
                  response = s3.get_object(Bucket=bucket, Key=key)
              
              filename = key.split('/')[-1]
              
              return Response(
                  response['Body'].read(),
                  headers={
                      'Content-Disposition': f'attachment; filename="{filename}"',
                      'Content-Type': response.get('ContentType', 'application/octet-stream')
                  }
              )
          except ClientError as e:
              error_code = e.response.get('Error', {}).get('Code', 'Unknown')
              error_msg = e.response.get('Error', {}).get('Message', str(e))
              app.logger.error(f"Download error: {error_code} - {error_msg}")
              return jsonify({'success': False, 'error': f'Download failed: {error_code}'}), 500
      
      @app.route('/upload/<zone>', methods=['POST'])
      @auth_required
      def upload(zone):
          if 'file' not in request.files:
              return jsonify({'success': False, 'error': 'No file provided'}), 400
          
          f = request.files['file']
          if not f.filename:
              return jsonify({'success': False, 'error': 'Empty filename'}), 400
          
          bucket = os.environ.get(f'{zone.upper()}_BUCKET')
          if not bucket:
              return jsonify({'success': False, 'error': f'Invalid zone: {zone}'}), 400
          
          sse = sse_params(zone)
          if not sse:
              return jsonify({'success': False, 'error': f'No encryption key for {zone}'}), 500
          
          username = request.authorization.username
          object_key = f'uploads/{username}/{f.filename}'
          
          try:
              s3 = get_s3()
              s3.put_object(
                  Bucket=bucket,
                  Key=object_key,
                  Body=f.read(),
                  **sse
              )
              return jsonify({
                  'success': True,
                  'message': f'Uploaded to {bucket}/{object_key}'
              })
          except ClientError as e:
              error_code = e.response.get('Error', {}).get('Code', 'Unknown')
              error_msg = e.response.get('Error', {}).get('Message', str(e))
              app.logger.error(f"S3 ClientError: {error_code} - {error_msg}")
              return jsonify({
                  'success': False,
                  'error': f'S3 Error ({error_code}): {error_msg}'
              }), 500
          except Exception as e:
              app.logger.error(f"Upload error: {traceback.format_exc()}")
              return jsonify({
                  'success': False,
                  'error': f'Upload failed: {str(e)}'
              }), 500
      
      @app.route('/health')
      def health():
          return jsonify({
              'status': 'OK',
              'zone1_bucket': os.environ.get('ZONE1_BUCKET', 'NOT SET'),
              'zone2_bucket': os.environ.get('ZONE2_BUCKET', 'NOT SET'),
              'livrables_bucket': os.environ.get('LIVRABLES_BUCKET', 'NOT SET'),
              'region': os.environ.get('SCW_REGION', 'NOT SET')
          })
      
      @app.route('/debug')
      @auth_required
      def debug():
          """Debug endpoint to test S3 connectivity"""
          results = {}
          s3 = get_s3()
          
          for zone in ['zone1', 'zone2', 'livrables']:
              bucket = os.environ.get(f'{zone.upper()}_BUCKET')
              if bucket:
                  try:
                      s3.head_bucket(Bucket=bucket)
                      results[zone] = {'bucket': bucket, 'status': 'accessible'}
                  except ClientError as e:
                      error_code = e.response.get('Error', {}).get('Code', 'Unknown')
                      results[zone] = {'bucket': bucket, 'status': 'error', 'code': error_code}
              else:
                  results[zone] = {'bucket': None, 'status': 'not configured'}
          
          return jsonify(results)
      
      if __name__ == '__main__':
          app.run(host='0.0.0.0', port=5000, debug=True)

  - path: /opt/upload-portal/requirements.txt
    content: |
      flask
      boto3
      bcrypt
      gunicorn

  - path: /etc/systemd/system/upload-portal.service
    content: |
      [Unit]
      Description=Upload Portal
      After=network.target
      
      [Service]
      Type=simple
      User=root
      WorkingDirectory=/opt/upload-portal
      EnvironmentFile=/opt/upload-portal/.env
      ExecStart=/opt/upload-portal/venv/bin/gunicorn -b 0.0.0.0:80 -w 2 --timeout 120 app:app
      Restart=always
      
      [Install]
      WantedBy=multi-user.target

  - path: /etc/motd
    content: |
      ==============================================================
        HACKATHON HDS - UPLOAD PORTAL
      ==============================================================
        Service: systemctl status upload-portal
        Logs: journalctl -u upload-portal -f
        Debug: curl http://localhost/health
      ==============================================================

runcmd:
  - mkdir -p /opt/upload-portal
  - cd /opt/upload-portal
  - python3 -m venv venv
  - /opt/upload-portal/venv/bin/pip install -r /opt/upload-portal/requirements.txt
  - systemctl daemon-reload
  - systemctl enable upload-portal
  - systemctl start upload-portal
CLOUDINIT
  }

  tags = ["hackathon", "upload-portal"]

  depends_on = [scaleway_iam_ssh_key.portal]

  lifecycle {
    ignore_changes = [user_data]
  }
}

#-------------------------------------------------------------------------------
# Store SSH key locally
#-------------------------------------------------------------------------------
resource "local_sensitive_file" "portal_ssh_key" {
  content         = tls_private_key.portal.private_key_openssh
  filename        = "${path.root}/keys/upload-portal/ssh_private_key.pem"
  file_permission = "0600"
}

#-------------------------------------------------------------------------------
# Store provider credentials
#-------------------------------------------------------------------------------
resource "local_sensitive_file" "provider_credentials" {
  for_each        = var.data_providers
  filename        = "${path.root}/keys/${lower(replace(replace(each.value.name, " ", "-"), "&", "and"))}/portal_credentials.txt"
  file_permission = "0600"
  content         = <<-EOT
# Upload Portal Credentials - ${each.value.name}

URL: http://${scaleway_instance_ip.portal.address}
Username: ${local.provider_credentials[each.key].username}
Password: ${local.provider_credentials[each.key].password}

## Debug endpoints
Health check: curl http://${scaleway_instance_ip.portal.address}/health
Debug S3: curl -u ${local.provider_credentials[each.key].username}:${local.provider_credentials[each.key].password} http://${scaleway_instance_ip.portal.address}/debug
EOT
}

#-------------------------------------------------------------------------------
# Store evaluator credentials for portal
#-------------------------------------------------------------------------------
resource "local_sensitive_file" "evaluator_portal_credentials" {
  filename        = "${path.root}/keys/evaluators/portal_credentials.txt"
  file_permission = "0600"
  content         = <<-EOT
# Upload Portal Credentials - Evaluators
# Access to browse uploaded files

URL: http://${scaleway_instance_ip.portal.address}
Username: ${local.evaluator_credentials.username}
Password: ${local.evaluator_credentials.password}

## Debug endpoints
Health check: curl http://${scaleway_instance_ip.portal.address}/health
Debug S3: curl -u ${local.evaluator_credentials.username}:${local.evaluator_credentials.password} http://${scaleway_instance_ip.portal.address}/debug
EOT
}

#-------------------------------------------------------------------------------
# Outputs
#-------------------------------------------------------------------------------
output "portal_url" {
  value = "http://${scaleway_instance_ip.portal.address}"
}

output "portal_ip" {
  value = scaleway_instance_ip.portal.address
}

output "portal_ssh_command" {
  value = "ssh -i keys/upload-portal/ssh_private_key.pem root@${scaleway_instance_ip.portal.address}"
}

output "provider_credentials" {
  value = {
    for key, creds in local.provider_credentials : key => {
      username = creds.username
      password = creds.password
    }
  }
  sensitive = true
}

output "evaluator_credentials" {
  value = {
    username = local.evaluator_credentials.username
    password = local.evaluator_credentials.password
  }
  sensitive = true
}
